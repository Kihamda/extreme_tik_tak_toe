name: CI — Lint & Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

# Cloudflare Pages が主デプロイ先。このワークフローは PR 段階の品質チェックのみ。
# main push 時のデプロイは build-and-deploy.yml が担う。
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      games: ${{ steps.filter.outputs.games }}
      portal: ${{ steps.filter.outputs.portal }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            games:
              - 'games/**'
            portal:
              - 'portal/**'

  lint-and-build-games:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.games == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: |
            games/*/package-lock.json

      - name: Lint & Build all games
        run: |
          set -e
          for pkg in games/*/package.json; do
            game_dir="$(dirname "$pkg")"
            game_id="$(basename "$game_dir")"
            [ "$game_id" = "_template" ] && continue
            echo "── checking: $game_id ──"
            (cd "$game_dir" && npm ci && npm run lint && npm run build)
          done

  portal-build:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.portal == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Check if portal exists
        id: check
        run: |
          if [ -d "portal" ] && [ -f "portal/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: portal/package-lock.json

      - name: Install & Build portal
        if: steps.check.outputs.exists == 'true'
        run: |
          npm ci
          npm run build
        working-directory: portal
