name: Build & Deploy to Cloudflare Pages

# ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ  + portal ã‚’1ã¤ã® dist/ ã«ãƒ“ãƒ«ãƒ‰ã—ã¦
# Cloudflare Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
#
# å¿…è¦ãª GitHub Secrets:
#   CLOUDFLARE_API_TOKEN   - Cloudflare API ãƒˆãƒ¼ã‚¯ãƒ³ (Pages:Edit æ¨©é™)
#   CLOUDFLARE_ACCOUNT_ID  - Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID
#
# å¿…è¦ãª GitHub Variables:
#   CF_PAGES_PROJECT_NAME  - Cloudflare Pages ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (ä¾‹: game-portal)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  # â”€â”€ ã‚¸ãƒ§ãƒ– 1: lint + build (å…¨ã‚²ãƒ¼ãƒ  + portal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (workspaces ä¸€æ‹¬)
      - name: Install dependencies
        run: npm ci

      # ãƒ¢ãƒŽãƒ¬ãƒç§»è¡Œå¾Œ: å„ã‚²ãƒ¼ãƒ ã® lint
      - name: Lint all games
        if: hashFiles('games/*/package.json') != ''
        run: |
          for pkg in games/*/package.json; do
            game_dir="$(dirname "$pkg")"
            game_id="$(basename "$game_dir")"
            [ "$game_id" = "_template" ] && continue
            echo "â”€â”€ lint: $game_id â”€â”€"
            (cd "$game_dir" && npm run lint)
          done

      # portal ã® lint
      - name: Lint portal
        if: hashFiles('portal/package.json') != ''
        run: |
          cd portal
          npm run lint --if-present

      # çµ±åˆãƒ“ãƒ«ãƒ‰
      - name: Build platform (all games + portal â†’ dist/)
        run: bash scripts/build-all.sh

      # dist/ ã‚’æ¬¡ã®ã‚¸ãƒ§ãƒ–ã«æ¸¡ã™
      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: platform-dist
          path: dist/
          retention-days: 1

  # â”€â”€ ã‚¸ãƒ§ãƒ– 2: Cloudflare Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ steps.cf-deploy.outputs.url }}
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: platform-dist
          path: dist/

      - name: Deploy to Cloudflare Pages
        id: cf-deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ vars.CF_PAGES_PROJECT_NAME }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Show deploy URL
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.cf-deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ§‹é€ **:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "/ â†’ portal (ã‚²ãƒ¼ãƒ ä¸€è¦§)" >> $GITHUB_STEP_SUMMARY
          echo "/games/[id]/ â†’ å„ã‚²ãƒ¼ãƒ " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
