name: Build & Deploy to XServer Static

# ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ  + portal ã‚’1ã¤ã® dist/ ã«ãƒ“ãƒ«ãƒ‰ã—ã¦
# XServer Static ã« FTPS (explicit TLS) ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
#
# å¿…è¦ãª GitHub Secrets:
#   FTP_SERVER    - FTPãƒ›ã‚¹ãƒˆå (ä¾‹: sv***.static.ne.jp)
#   FTP_USERNAME  - FTPãƒ¦ãƒ¼ã‚¶ãƒ¼å
#   FTP_PASSWORD  - FTPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
#
# ä»»æ„ã® GitHub Variables:
#   FTP_SERVER_DIR - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (æœªè¨­å®šæ™‚: public_html/)
#
# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ§‹é€ :
#   public_html/              â† portal (ã‚²ãƒ¼ãƒ ä¸€è¦§)
#   public_html/games/[id]/   â† å„ã‚²ãƒ¼ãƒ 

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  # â”€â”€ ã‚¸ãƒ§ãƒ– 1: lint + build (å…¨ã‚²ãƒ¼ãƒ  + portal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint all games
        if: hashFiles('games/*/package.json') != ''
        run: |
          for pkg in games/*/package.json; do
            game_dir="$(dirname "$pkg")"
            game_id="$(basename "$game_dir")"
            [ "$game_id" = "_template" ] && continue
            echo "â”€â”€ lint: $game_id â”€â”€"
            (cd "$game_dir" && npm run lint)
          done

      - name: Lint portal
        if: hashFiles('portal/package.json') != ''
        run: |
          cd portal
          npm run lint --if-present

      - name: Build platform (all games + portal â†’ dist/)
        run: bash scripts/build-all.sh

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: platform-dist
          path: dist/
          retention-days: 1

  # â”€â”€ ã‚¸ãƒ§ãƒ– 2: XServer Static ã« FTPS ã§ãƒ‡ãƒ—ãƒ­ã‚¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: platform-dist
          path: dist/

      # SamKirkland/FTP-Deploy-Action:
      # - å·®åˆ†åŒæœŸ (.ftp-deploy-sync-state.json ã§ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒãƒƒã‚·ãƒ¥ç®¡ç†)
      # - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è»¢é€ã™ã‚‹ãŸã‚2å›žç›®ä»¥é™ã¯é«˜é€Ÿ
      # - protocol: ftps = explicit TLS (STARTTLS) â† Xserver Static æŽ¨å¥¨
      - name: Deploy to XServer Static via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./dist/
          server-dir: ${{ vars.FTP_SERVER_DIR || 'public_html/' }}
          security: strict
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**

      - name: Show deploy summary
        if: always()
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† (XServer Static)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | FTPS (explicit TLS) |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚µãƒ¼ãƒãƒ¼ | \`${{ secrets.FTP_SERVER }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ | \`${{ vars.FTP_SERVER_DIR || 'public_html/' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚µã‚¤ãƒˆæ§‹é€ **:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "public_html/             â†’ portal (ã‚²ãƒ¼ãƒ ä¸€è¦§)" >> $GITHUB_STEP_SUMMARY
          echo "public_html/games/[id]/  â†’ å„ã‚²ãƒ¼ãƒ " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
