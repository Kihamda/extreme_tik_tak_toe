name: Build & Deploy to XServer Static

# ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ  + portal ã‚’1ã¤ã® dist/ ã«ãƒ“ãƒ«ãƒ‰ã—ã¦
# XServer Static ã« FTPS (explicit TLS) ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
#
# å¿…è¦ãª GitHub Secrets:
#   FTP_SERVER    - FTPãƒ›ã‚¹ãƒˆå (ä¾‹: sv***.static.ne.jp)
#   FTP_USERNAME  - FTPãƒ¦ãƒ¼ã‚¶ãƒ¼å
#   FTP_PASSWORD  - FTPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
#
# ä»»æ„ã® GitHub Variables:
#   FTP_SERVER_DIR - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (æœªè¨­å®šæ™‚: public_html/)
#
# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ§‹é€ :
#   public_html/              â† portal (ã‚²ãƒ¼ãƒ ä¸€è¦§)
#   public_html/games/[id]/   â† å„ã‚²ãƒ¼ãƒ 

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  # â”€â”€ ã‚¸ãƒ§ãƒ– 0: å¤‰æ›´æ¤œå‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      portal: ${{ steps.filter.outputs.portal }}
      any_game: ${{ steps.games.outputs.any }}
      game_ids: ${{ steps.games.outputs.ids }}
      force_full: ${{ steps.force.outputs.full }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # HEAD ã¨ HEAD~1 ã®å·®åˆ†å–å¾—ã«å¿…è¦

      - name: Detect portal / scripts changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            portal:
              - 'portal/**'
            full_rebuild:
              - 'scripts/**'
              - 'package.json'
              - 'package-lock.json'

      # ãƒ•ãƒ«ãƒ“ãƒ«ãƒ‰ãƒ•ãƒ©ã‚°: scriptså¤‰æ›´ãƒ»ä¾å­˜å¤‰æ›´ãƒ»workflow_dispatch ã®ã„ãšã‚Œã‹
      - name: Set force-full flag
        id: force
        run: |
          if [ "${{ steps.filter.outputs.full_rebuild }}" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "full=true" >> $GITHUB_OUTPUT
          else
            echo "full=false" >> $GITHUB_OUTPUT
          fi

      # å¤‰æ›´ã•ã‚ŒãŸã‚²ãƒ¼ãƒ IDã‚’æ¤œå‡º (ä¾‹: ["ntiktaktoe","game2"])
      - name: Detect changed game IDs
        id: games
        run: |
          if [ "${{ steps.force.outputs.full }}" = "true" ]; then
            IDS=$(ls games/ 2>/dev/null | grep -v '^_template$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            BEFORE="${{ github.event.before }}"
            [ "$BEFORE" = "0000000000000000000000000000000000000000" ] && BEFORE="HEAD~1"
            IDS=$(git diff --name-only "$BEFORE" "${{ github.sha }}" 2>/dev/null \
              | grep '^games/' \
              | sed 's|^games/||; s|/.*||' \
              | sort -u \
              | grep -v '^_template$' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))' \
              || echo '[]')
          fi
          echo "ids=$IDS" >> $GITHUB_OUTPUT
          ANY=$(echo "$IDS" | jq '. | length > 0')
          echo "any=$ANY" >> $GITHUB_OUTPUT
          echo "å¤‰æ›´ã‚²ãƒ¼ãƒ : $IDS"

  # â”€â”€ ã‚¸ãƒ§ãƒ– 1: lint + build (å¤‰æ›´ã‚²ãƒ¼ãƒ  + portal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    # ä½•ã‚‚å¤‰ã‚ã£ã¦ã„ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— (workflow_dispatch ã¯å¸¸ã«å®Ÿè¡Œ)
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.portal == 'true' ||
      needs.detect-changes.outputs.any_game == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      # å¤‰æ›´ã‚²ãƒ¼ãƒ ã®ã¿ lint (ãƒ•ãƒ«ãƒ“ãƒ«ãƒ‰æ™‚ã¯å…¨ã‚²ãƒ¼ãƒ )
      - name: Lint changed games
        run: |
          GAME_IDS='${{ needs.detect-changes.outputs.game_ids }}'
          FORCE='${{ needs.detect-changes.outputs.force_full }}'
          for pkg in games/*/package.json; do
            game_dir="$(dirname "$pkg")"
            game_id="$(basename "$game_dir")"
            [ "$game_id" = "_template" ] && continue
            # ãƒ•ãƒ«ãƒ“ãƒ«ãƒ‰ã§ãªã‘ã‚Œã°å¤‰æ›´å¯¾è±¡ã®ã¿ lint
            if [ "$FORCE" != "true" ] && ! echo "$GAME_IDS" | jq -e --arg id "$game_id" '. | index($id) != null' > /dev/null 2>&1; then
              echo "  â­  lint skip: $game_id (å¤‰æ›´ãªã—)"
              continue
            fi
            echo "â”€â”€ lint: $game_id â”€â”€"
            (cd "$game_dir" && npm run lint)
          done

      - name: Lint portal
        if: needs.detect-changes.outputs.portal == 'true' || needs.detect-changes.outputs.force_full == 'true'
        run: |
          cd portal
          npm run lint --if-present

      - name: Build platform (å¤‰æ›´ã‚²ãƒ¼ãƒ  + portal â†’ dist/)
        env:
          BUILD_GAME_IDS: ${{ needs.detect-changes.outputs.game_ids }}
          FORCE_FULL_BUILD: ${{ needs.detect-changes.outputs.force_full }}
          PORTAL_CHANGED: ${{ needs.detect-changes.outputs.portal }}
        run: bash scripts/build-all.sh

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: platform-dist
          path: dist/
          retention-days: 1

  # â”€â”€ ã‚¸ãƒ§ãƒ– 2: XServer Static ã« FTPS ã§ãƒ‡ãƒ—ãƒ­ã‚¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: platform-dist
          path: dist/

      # SamKirkland/FTP-Deploy-Action:
      # - å·®åˆ†åŒæœŸ (.ftp-deploy-sync-state.json ã§ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒãƒƒã‚·ãƒ¥ç®¡ç†)
      # - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è»¢é€ã™ã‚‹ãŸã‚2å›žç›®ä»¥é™ã¯é«˜é€Ÿ
      # - protocol: ftps = explicit TLS (STARTTLS) â† Xserver Static æŽ¨å¥¨
      - name: Deploy to XServer Static via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./dist/
          server-dir: ${{ vars.FTP_SERVER_DIR || 'public_html/' }}
          security: strict
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**

      - name: Show deploy summary
        if: always()
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† (XServer Static)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | FTPS (explicit TLS) |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚µãƒ¼ãƒãƒ¼ | \`${{ secrets.FTP_SERVER }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ | \`${{ vars.FTP_SERVER_DIR || 'public_html/' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚µã‚¤ãƒˆæ§‹é€ **:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "public_html/             â†’ portal (ã‚²ãƒ¼ãƒ ä¸€è¦§)" >> $GITHUB_STEP_SUMMARY
          echo "public_html/games/[id]/  â†’ å„ã‚²ãƒ¼ãƒ " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
