name: Release Pipeline â€” Build & SNS Post

# æ–°ä½œã‚²ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹æ™‚ã«å®Ÿè¡Œ:
# 1. ãƒ“ãƒ«ãƒ‰æœ€çµ‚ç¢ºèª
# 2. Twitter / X ã«æŠ•ç¨¿
#
# å¿…è¦ãª GitHub Secrets:
#   TWITTER_API_KEY            - Twitter API v2 Consumer Key
#   TWITTER_API_SECRET         - Twitter API v2 Consumer Secret
#   TWITTER_ACCESS_TOKEN       - Twitter API v2 Access Token
#   TWITTER_ACCESS_TOKEN_SECRET - Twitter API v2 Access Token Secret
#
# ä½¿ã„æ–¹:
#   GitHub Actions ã‚¿ãƒ– â†’ "Release Pipeline" â†’ "Run workflow"
#   game_id ã¨ game_title ã¨ game_url ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œ

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "ã‚²ãƒ¼ãƒ ID (ä¾‹: ntiktaktoe)"
        required: true
        type: string
      game_title:
        description: "ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: nç›®ä¸¦ã¹)"
        required: true
        type: string
      game_url:
        description: "Vercel ã® URL (ä¾‹: https://ntiktaktoe.vercel.app)"
        required: true
        type: string
      game_description:
        description: "ä¸€è¨€èª¬æ˜ (100æ–‡å­—ä»¥å†…)"
        required: true
        type: string
      post_to_twitter:
        description: "Twitter ã«æŠ•ç¨¿ã™ã‚‹"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

  # ã‚¿ã‚° push ã§ã‚‚èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ (games/ntiktaktoe@v1.0.0 å½¢å¼)
  push:
    tags:
      - "games/*@v*"

jobs:
  build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve game directory
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            GAME_ID=$(echo "${{ github.ref_name }}" | sed 's|games/||' | sed 's|@.*||')
          else
            GAME_ID="${{ inputs.game_id }}"
          fi
          echo "game_id=$GAME_ID" >> $GITHUB_OUTPUT
          if [ -d "games/$GAME_ID" ]; then
            echo "game_dir=games/$GAME_ID" >> $GITHUB_OUTPUT
          else
            echo "game_dir=." >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint & Build
        run: |
          npm run lint
          npm run build
        working-directory: ${{ steps.resolve.outputs.game_dir }}

  post-twitter:
    runs-on: ubuntu-latest
    needs: build-check
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.post_to_twitter == 'true') ||
      (github.event_name == 'push')
    steps:
      - name: Compose tweet text
        id: tweet
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TITLE="${{ inputs.game_title }}"
            URL="${{ inputs.game_url }}"
            DESC="${{ inputs.game_description }}"
          else
            GAME_ID=$(echo "${{ github.ref_name }}" | sed 's|games/||' | sed 's|@.*||')
            TITLE="$GAME_ID"
            URL="https://$GAME_ID.vercel.app"
            DESC="æ–°ã—ã„ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼"
          fi

          # 280æ–‡å­—ä»¥å†…ã«åã¾ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
          TEXT="ğŸ® æ–°ä½œå…¬é–‹ï¼ã€Œ${TITLE}ã€

${DESC}

â–¶ ${URL}

#ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ  #ç„¡æ–™ã‚²ãƒ¼ãƒ  #indiegame"

          # æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å‡ºåŠ›
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Twitter / X
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          # Twitter API v2 ã§æŠ•ç¨¿ (OAuth 1.0a)
          # twitter-api-v2 ãŒ Secrets æœªè¨­å®šãªã‚‰è­¦å‘Šã‚’å‡ºã—ã¦ã‚¹ã‚­ãƒƒãƒ—
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "âš ï¸  TWITTER_API_KEY ãŒæœªè¨­å®šã§ã™ã€‚æŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "   GitHub Secrets ã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:"
            echo "   - TWITTER_API_KEY"
            echo "   - TWITTER_API_SECRET"
            echo "   - TWITTER_ACCESS_TOKEN"
            echo "   - TWITTER_ACCESS_TOKEN_SECRET"
            exit 0
          fi

          # OAuth 1.0a ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
          TIMESTAMP=$(date +%s)
          NONCE=$(openssl rand -hex 16)
          TWEET_TEXT=$(cat << 'TWEET'
          ${{ steps.tweet.outputs.text }}
          TWEET
          )

          # curl ã§ Twitter API v2 ã«æŠ•ç¨¿
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.twitter.com/2/tweets" \
            --oauth1-consumer-key "$TWITTER_API_KEY" \
            --oauth1-consumer-secret "$TWITTER_API_SECRET" \
            --oauth1-access-token "$TWITTER_ACCESS_TOKEN" \
            --oauth1-access-token-secret "$TWITTER_ACCESS_TOKEN_SECRET" \
            -H "Content-Type: application/json" \
            -d "{\"text\": $(echo "$TWEET_TEXT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read().strip()))')}" \
            2>&1 || true)

          echo "Response: $RESPONSE"

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Twitter æŠ•ç¨¿æˆåŠŸ"
          else
            echo "âš ï¸  Twitter æŠ•ç¨¿å¤±æ•— (HTTP $HTTP_CODE)"
            echo "   æ‰‹å‹•ã§æŠ•ç¨¿ã—ã¦ãã ã•ã„"
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [build-check, post-twitter]
    if: always()
    steps:
      - name: Job Summary
        run: |
          echo "## ğŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¹ãƒ†ãƒƒãƒ— | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Twitter Post | ${{ needs.post-twitter.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**ã‚²ãƒ¼ãƒ **: ${{ inputs.game_title }}" >> $GITHUB_STEP_SUMMARY
            echo "**URL**: ${{ inputs.game_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> main ã¸ã® push å¾Œã€build-and-deploy.yml ãŒ Cloudflare Pages ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
          fi
