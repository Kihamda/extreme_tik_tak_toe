name: Release Pipeline ‚Äî Build & SNS Post

# Êñ∞‰Ωú„Ç≤„Éº„É†„É™„É™„Éº„ÇπÊôÇ„Å´ÂÆüË°å:
# 1. „Éì„É´„ÉâÊúÄÁµÇÁ¢∫Ë™ç
# 2. Twitter / X „Å´ÊäïÁ®ø
#
# ÂøÖË¶Å„Å™ GitHub Secrets:
#   TWITTER_API_KEY            - Twitter API v2 Consumer Key
#   TWITTER_API_SECRET         - Twitter API v2 Consumer Secret
#   TWITTER_ACCESS_TOKEN       - Twitter API v2 Access Token
#   TWITTER_ACCESS_TOKEN_SECRET - Twitter API v2 Access Token Secret
#
# ‰Ωø„ÅÑÊñπ:
#   GitHub Actions „Çø„Éñ ‚Üí "Release Pipeline" ‚Üí "Run workflow"
#   game_id „Å® game_title „Å® game_url „ÇíÂÖ•Âäõ„Åó„Å¶ÂÆüË°å

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "„Ç≤„Éº„É†ID (‰æã: ntiktaktoe)"
        required: true
        type: string
      game_title:
        description: "„Ç≤„Éº„É†„Çø„Ç§„Éà„É´ (‰æã: nÁõÆ‰∏¶„Åπ)"
        required: true
        type: string
      game_url:
        description: "Vercel „ÅÆ URL (‰æã: https://ntiktaktoe.vercel.app)"
        required: true
        type: string
      game_description:
        description: "‰∏ÄË®ÄË™¨Êòé (100ÊñáÂ≠ó‰ª•ÂÜÖ)"
        required: true
        type: string
      post_to_twitter:
        description: "Twitter „Å´ÊäïÁ®ø„Åô„Çã"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

  # „Çø„Ç∞ push „Åß„ÇÇËµ∑Âãï„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã (games/ntiktaktoe@v1.0.0 ÂΩ¢Âºè)
  push:
    tags:
      - "games/*@v*"

jobs:
  build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve game directory
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            GAME_ID=$(echo "${{ github.ref_name }}" | sed 's|games/||' | sed 's|@.*||')
          else
            GAME_ID="${{ inputs.game_id }}"
          fi
          echo "game_id=$GAME_ID" >> $GITHUB_OUTPUT
          if [ -d "games/$GAME_ID" ]; then
            echo "game_dir=games/$GAME_ID" >> $GITHUB_OUTPUT
          else
            echo "game_dir=." >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint & Build
        run: |
          npm run lint
          npm run build
        working-directory: ${{ steps.resolve.outputs.game_dir }}

  post-twitter:
    runs-on: ubuntu-latest
    needs: build-check
    if: "(github.event_name == 'workflow_dispatch' && inputs.post_to_twitter == 'true') || github.event_name == 'push'"
    steps:
      - name: Compose tweet text
        id: tweet
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TITLE="${{ inputs.game_title }}"
            URL="${{ inputs.game_url }}"
            DESC="${{ inputs.game_description }}"
          else
            GAME_ID=$(echo "${{ github.ref_name }}" | sed 's|games/||' | sed 's|@.*||')
            TITLE="$GAME_ID"
            URL="https://$GAME_ID.vercel.app"
            DESC="Êñ∞„Åó„ÅÑ„Éñ„É©„Ç¶„Ç∂„Ç≤„Éº„É†„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„ÅüÔºÅ"
          fi

          TEXT="üéÆ Êñ∞‰ΩúÂÖ¨ÈñãÔºÅ„Äå${TITLE}„Äç

${DESC}

‚ñ∂ ${URL}

#„Éñ„É©„Ç¶„Ç∂„Ç≤„Éº„É† #ÁÑ°Êñô„Ç≤„Éº„É† #indiegame"

          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Twitter / X
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWEET_TEXT: ${{ steps.tweet.outputs.text }}
        run: |
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "‚ö†Ô∏è  TWITTER_API_KEY „ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇÊäïÁ®ø„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
            echo "   GitHub Secrets „Å´‰ª•‰∏ã„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ:"
            echo "   - TWITTER_API_KEY / TWITTER_API_SECRET"
            echo "   - TWITTER_ACCESS_TOKEN / TWITTER_ACCESS_TOKEN_SECRET"
            exit 0
          fi

          # twitter-api-v2 „Çí‰∏ÄÊôÇ„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶ÊäïÁ®ø
          cd /tmp
          echo '{}' > package.json
          npm install --silent twitter-api-v2

          node - << 'SCRIPT'
          const { TwitterApi } = require('/tmp/node_modules/twitter-api-v2');
          const client = new TwitterApi({
            appKey:     process.env.TWITTER_API_KEY,
            appSecret:  process.env.TWITTER_API_SECRET,
            accessToken: process.env.TWITTER_ACCESS_TOKEN,
            accessSecret: process.env.TWITTER_ACCESS_TOKEN_SECRET,
          });
          client.v2.tweet(process.env.TWEET_TEXT)
            .then(r => { console.log('‚úÖ Twitter ÊäïÁ®øÊàêÂäü:', r.data.id); process.exit(0); })
            .catch(e => { console.warn('‚ö†Ô∏è  Twitter ÊäïÁ®øÂ§±Êïó:', e.message); process.exit(0); });
          SCRIPT

  summary:
    runs-on: ubuntu-latest
    needs: [build-check, post-twitter]
    if: always()
    steps:
      - name: Job Summary
        run: |
          echo "## üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| „Çπ„ÉÜ„ÉÉ„Éó | ÁµêÊûú |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Twitter Post | ${{ needs.post-twitter.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**„Ç≤„Éº„É†**: ${{ inputs.game_title }}" >> $GITHUB_STEP_SUMMARY
            echo "**URL**: ${{ inputs.game_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> main „Å∏„ÅÆ push Âæå„ÄÅbuild-and-deploy.yml „Åå Cloudflare Pages „Å´Ëá™Âãï„Éá„Éó„É≠„Ç§„Åó„Åæ„Åô" >> $GITHUB_STEP_SUMMARY
          fi
