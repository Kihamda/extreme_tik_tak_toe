---
import Layout from "../components/Layout.astro";
import GameCard from "../components/GameCard.astro";
import gamesData from "../data/games.json";

const games = [...gamesData.games];

const byDateDesc = [...games].sort(
  (a, b) => Date.parse(b.publishedAt) - Date.parse(a.publishedAt)
);

const featuredGames = games.filter((game) => game.featured);
const newestGames = byDateDesc.slice(0, 2);

const recommendedGames = [...games]
  .sort((a, b) => {
    const score = (game: (typeof games)[number]) => {
      let total = 0;
      if (game.featured) total += 3;
      if (game.tags.includes("multiplayer")) total += 2;
      if (game.tags.includes("arcade") || game.tags.includes("reflex")) total += 1;
      return total;
    };

    const scoreDiff = score(b) - score(a);
    if (scoreDiff !== 0) return scoreDiff;
    return Date.parse(b.publishedAt) - Date.parse(a.publishedAt);
  })
  .slice(0, 3);

const allGames = [...games].sort((a, b) => {
  const featuredDiff = Number(b.featured) - Number(a.featured);
  if (featuredDiff !== 0) return featuredDiff;
  return Date.parse(b.publishedAt) - Date.parse(a.publishedAt);
});

const fallbackRandom = allGames[0];
---

<Layout
  title="Game Portal"
  description="今日の気分で遊べるブラウザゲームポータル 新着 おすすめ ランダムからすぐプレイ"
>
  <section class="hero" aria-labelledby="top-title">
    <p class="eyebrow">今日の1本が見つかるゲームポータル</p>
    <h1 id="top-title">遊ぶまで3秒 新着も定番もここで完結</h1>
    <p class="lead">
      反射神経で燃える日も じっくり頭を使いたい日もある その気分に合わせてすぐ遊べるようにまとめた
    </p>

    <div class="hero-cta" data-random-cta data-paths={JSON.stringify(allGames.map((game) => game.path))}>
      <a href="#new">新着から選ぶ</a>
      <a href="#recommended">おすすめを見る</a>
      <a href={fallbackRandom?.path ?? "/"} data-random-link>ランダムで1本</a>
    </div>

    <div class="hero-stats" aria-label="ゲーム数サマリー">
      <p><strong>{games.length}</strong> タイトル公開中</p>
      <p><strong>{newestGames.length}</strong> 件の新着</p>
      <p><strong>{featuredGames.length}</strong> 件の注目作</p>
    </div>
  </section>

  <section id="new" class="section">
    <div class="section-head">
      <h2>新着ゲーム</h2>
      <p>追加されたばかりのゲーム まずはここから触るのが最短ルート</p>
    </div>
    <div class="grid">
      {newestGames.map((game) => <GameCard game={game} badge="NEW" />)}
    </div>
  </section>

  <section id="recommended" class="section">
    <div class="section-head">
      <h2>おすすめピック</h2>
      <p>初見でも遊びやすいものを中心に 厳選して並べた</p>
    </div>
    <div class="grid">
      {recommendedGames.map((game) => <GameCard game={game} badge={game.featured ? "注目" : "PICK"} />)}
    </div>
  </section>

  <section id="all" class="section">
    <div class="section-head">
      <h2>全タイトル</h2>
      <p>迷ったら詳細を開いてルール確認 そのままワンタップでプレイへ</p>
    </div>
    <div class="grid">
      {allGames.map((game) => <GameCard game={game} />)}
    </div>
  </section>

  <script is:inline>
    const root = document.querySelector("[data-random-cta]");
    const randomLink = root?.querySelector("[data-random-link]");
    const rawPaths = root?.getAttribute("data-paths");

    if (randomLink && rawPaths) {
      try {
        const paths = JSON.parse(rawPaths);
        if (Array.isArray(paths) && paths.length > 0) {
          const index = Math.floor(Math.random() * paths.length);
          randomLink.setAttribute("href", paths[index]);
        }
      } catch {
      }
    }
  </script>
</Layout>

<style>
  .hero {
    display: grid;
    gap: 14px;
    margin-bottom: 24px;
    padding: 20px;
    border-radius: 20px;
    background: linear-gradient(160deg, #111827 0%, #1e293b 55%, #334155 100%);
    color: #f8fafc;
  }

  .eyebrow {
    margin: 0;
    font-size: 13px;
    font-weight: 700;
    color: #bfdbfe;
  }

  .hero h1 {
    margin: 0;
    font-size: clamp(26px, 5.5vw, 40px);
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .lead {
    margin: 0;
    color: #cbd5e1;
    max-width: 60ch;
  }

  .hero-cta {
    display: grid;
    gap: 10px;
  }

  .hero-cta a {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    min-height: 44px;
    padding: 0 14px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 700;
    background: #f8fafc;
    color: #0f172a;
  }

  .hero-cta a:last-child {
    background: #22d3ee;
    color: #0f172a;
  }

  .hero-stats {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 8px;
  }

  .hero-stats p {
    margin: 0;
    padding: 10px;
    border-radius: 10px;
    background: rgba(148, 163, 184, 0.2);
    font-size: 13px;
    color: #cbd5e1;
  }

  .hero-stats strong {
    display: block;
    font-size: 18px;
    color: #f8fafc;
  }

  .section {
    display: grid;
    gap: 12px;
    margin-bottom: 26px;
  }

  .section-head h2 {
    margin: 0;
    font-size: 22px;
  }

  .section-head p {
    margin: 6px 0 0;
    color: #475569;
  }

  .grid {
    display: grid;
    gap: 16px;
  }

  @media (min-width: 760px) {
    .hero {
      padding: 28px;
    }

    .hero-cta {
      display: flex;
      flex-wrap: wrap;
    }

    .hero-cta a {
      justify-content: flex-start;
    }
  }
</style>
